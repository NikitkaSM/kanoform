<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
				name="viewport">
	<meta content="ie=edge" http-equiv="X-UA-Compatible">
	<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
	<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
	<script crossorigin="anonymous"
					integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA=="
					referrerpolicy="no-referrer"
					src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" referrerpolicy="no-referrer"
				rel="stylesheet" />
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
	<script src="https://cdnout.com/react-chartjs-2/index.js"></script>
	<link href="/static/css/analytics.module.css" rel="stylesheet">
	<title>Аналитика анкеты </title>
</head>
<body>
<div class="bg-gray-200 h-full" id="root"></div>
<script type="text/babel">
	const url = "/api/analytics/"
	const { useState, useEffect } = React
	const Bar = window["ReactChartjs2"].Bar
	const Doughnut = window["ReactChartjs2"].Doughnut
	const questionaryId = window.location.pathname.replace(/\D/g, "")
	const barOptions = {
		tooltips: {
			enabled: true
		},
		scales: {
			x: {
				grid: {
					display: false
				}
			}
		},
		responsive: true,
		plugins: {
			legend: {
				position: "top"
			},
			title: {
				display: false
			}
		}
	}

	const doughnutOptions = {
		responsive: true,
		plugins: {
			legend: {
				position: "right"
			}
		}
	}

	const Filters = (props) => {                            // props для передачи фильтров
		const selectOptions = [0, 1, 2, 3, 4, 5]
		return (
			<div className="flex justify-between flex-wrap order-3 bg-white p-5">
				{selectOptions.map(element => <select key={element}
																							className="p-3 m-2 w-5/12 rounded bg-white shadow-md cursor-pointer hover:bg-gray-200 transition-all duration-400">
					<option>Фильтр</option>
				</select>)}
			</div>
		)
	}

	const FeatureInfo = (props) => {
		const labels = ["Обязательная", "Привлекательная", "Необязательная", "Одномерная", "Неважная"].reverse()
		let middleImportance = 0
		const answerVariants = props.answerVariants[0]
		answerVariants?.forEach(answerVariant => middleImportance += answerVariant
		)
		middleImportance = middleImportance / answerVariants?.length
		const digits = [1, 2, 3, 4, 7]
		const barData = {
			labels,
			datasets: [
				{
					label: "Лучший результат",
					data: digits.map(digit => digit),
					backgroundColor: [
						"blue"
					]
				}
			]
		}
		const doughnutData = {
			labels,
			datasets: [
				{
					data: digits.map(digit => digit + 1),
					backgroundColor: [
						"blue",
						"yellow",
						"red",
						"green",
						"orange"
					]
				}
			]
		}
		return (
			<div className="p-14">
         <span
					 className="text-xl font-semibold">{props.featureName}</span>
				<div className="p-8 flex flex-col">
					<div>
						<Bar data={barData} options={barOptions} width={110} height={25} />
						<div className="flex flex-row items-center ">
							<div className="w-4/12"><Doughnut data={doughnutData} options={doughnutOptions} /></div>
							<div className="w-full text-center"><p className="text-lg font-semibold">Средняя важность: <span
								className="font-normal">{middleImportance.toFixed(1)}</span></p></div>
						</div>
					</div>
				</div>
			</div>
		)
	}

	const App = () => {
		const [questionary, setQuestionary] = useState({})
		const [error, setError] = useState(false)
		const [answerVariants, setAnswerVariants] = useState([])

		function getAnswerVariants(featureQuestions) {
			featureQuestions.map(fQuestion => {
				axios.get(`${url}${questionaryId}`)
			})
		}


		useEffect(() => {
			axios.get(`/api/questionary/${questionaryId}`)
				.then(async response => {
					setQuestionary(prev => ({ ...prev, ...response.data }))
					document.title = `Аналитика ${response.data.name}`
					await getAnswerVariants(response.data.feature_questions)
				})
				.catch(error => setError(true))
		}, [])

		return (
			<>
				{!error &&
					<div className="shadow-md m-auto w-3/4 bg-white">
						<Filters />
						{questionary.feature_questions?.map(question => <FeatureInfo key={question.id}
																																				 featureName={question.feature_name}
																																				 answerVariants={answerVariants} />)}
					</div>}
				{error && <div className="text-5xl text-center bg-white">Анкета не найдена</div>}
			</>
		)
	}

	ReactDOM
		.createRoot(document.getElementById("root"))
		.render(<App />)
</script>
</body>
</html>